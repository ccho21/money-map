<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Socket.io Test with Login</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #log {
        white-space: pre-line;
        margin-top: 1em;
        background: #f5f5f5;
        padding: 1em;
        border-radius: 8px;
      }
      button {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ’» Socket.io ì‹¤ì‹œê°„ ì˜ˆì‚° ì´ˆê³¼ í…ŒìŠ¤íŠ¸</h2>
    <p>ìœ ì € ë¡œê·¸ì¸ í›„ ì†Œì¼“ ì—°ê²° ë° ê±°ë˜ ìƒì„± ê°€ëŠ¥</p>

    <button onclick="loginAndConnect()">ğŸ” ë¡œê·¸ì¸ & ì†Œì¼“ ì—°ê²°</button>
    <button onclick="createTransaction()">ğŸ’¸ ê±°ë˜ ìƒì„±</button>

    <div id="log">ë¡œê·¸ ì—†ìŒ...</div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      let token = '';
      let socket = null;

      const log = (msg) => {
        const logDiv = document.getElementById('log');
        logDiv.innerText += `\n${msg}`;
      };

      async function loginAndConnect() {
        log('ğŸ” ë¡œê·¸ì¸ ì¤‘...');

        const res = await fetch('http://localhost:3000/auth/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'seeduser@example.com',
            password: 'secure123',
          }),
        });

        if (!res.ok) {
          log('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨');
          return;
        }

        const data = await res.json();
        token = data.access_token;

        log('âœ… ë¡œê·¸ì¸ ì„±ê³µ, í† í° ë°›ìŒ');

        socket = io('http://localhost:3000', {
          auth: { token },
        });

        socket.on('connect', () => {
          log('âœ… ì†Œì¼“ ì—°ê²°ë¨: ' + socket.id);
        });

        socket.on('budget_alert', (data) => {
          log(`ğŸš¨ ì˜ˆì‚° ì´ˆê³¼ ì•Œë¦¼: ${JSON.stringify(data)}`);
        });
      }

      async function createTransaction() {
        if (!token) {
          log('â— ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
          return;
        }

        // ì˜ˆì‚°ì„ ì´ˆê³¼í•˜ê²Œ ë§Œë“¤ê³  ì‹¶ì€ ì¹´í…Œê³ ë¦¬ IDë¡œ ìˆ˜ì • í•„ìš”!
        const categoryId = prompt('ì¹´í…Œê³ ë¦¬ UUID ì…ë ¥:', '');

        if (!categoryId) {
          log('âŒ categoryId ì—†ìŒ');
          return;
        }

        const res = await fetch('http://localhost:3000/transactions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            type: 'expense',
            amount: 150000, // ì˜ˆì‚°ë³´ë‹¤ ë†’ì€ ê°’ ì…ë ¥!
            categoryId,
            date: new Date().toISOString(),
            note: 'í…ŒìŠ¤íŠ¸ ê±°ë˜',
          }),
        });

        if (!res.ok) {
          log('âŒ ê±°ë˜ ìƒì„± ì‹¤íŒ¨');
          return;
        }

        const result = await res.json();
        log(`âœ… ê±°ë˜ ìƒì„± ì™„ë£Œ: ${result.id}`);
      }
    </script>
  </body>
</html>
